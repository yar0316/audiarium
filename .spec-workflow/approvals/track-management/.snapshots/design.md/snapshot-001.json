{
  "id": "snapshot_1764760518111_u942v7kjl",
  "approvalId": "approval_1764760518059_ef4n262x4",
  "approvalTitle": "楽曲管理 - 設計ドキュメント",
  "version": 1,
  "timestamp": "2025-12-03T11:15:18.111Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: 楽曲管理（Track Management）\r\n\r\n## Overview\r\n\r\n楽曲（Track）の CRUD 操作と検索機能を提供するコア機能。サーバーサイド（API + Service + Repository）とクライアントサイド（UI + Store + Client）の両層で構成される。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n\r\n- **Next.js 16**: App Router を使用\r\n- **Supabase**: PostgreSQL + Storage\r\n- **TypeScript**: 厳格な型定義\r\n- **Tailwind CSS**: スタイリング\r\n\r\n### Project Structure (structure.md)\r\n\r\n- **サーバーサイド**: `server/api/`, `server/services/`, `server/repositories/` に集約\r\n- **クライアントサイド**: `components/`, `stores/`, `services/` で分離\r\n- **型定義**: `types/models/`, `types/interfaces/`, `types/api/` で管理\r\n- **インターフェース**: `ITrackRepository`, `ITrackService` を使用\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n\r\n- **Tailwind CSS**: UI コンポーネントのスタイリング\r\n- **Supabase Client**: `server/lib/supabase.ts` で共通化\r\n\r\n### Integration Points\r\n\r\n- **Supabase Storage**: MP3 ファイルの保存・取得・削除\r\n- **Supabase Database**: 楽曲メタデータの CRUD\r\n\r\n## Architecture\r\n\r\n```mermaid\r\ngraph TD\r\n    subgraph Client\r\n        UI[TrackList / TrackUpload]\r\n        Store[trackStore]\r\n        Client[trackClient]\r\n    end\r\n    \r\n    subgraph Server\r\n        API[/api/tracks]\r\n        Service[TrackService]\r\n        Repo[TrackRepository]\r\n        Supabase[(Supabase)]\r\n    end\r\n    \r\n    UI --> Store\r\n    Store --> Client\r\n    Client -->|HTTP| API\r\n    API --> Service\r\n    Service --> Repo\r\n    Repo --> Supabase\r\n```\r\n\r\n### レイヤー構成\r\n\r\n```\r\n┌─────────────────────────────────────────────────────────────┐\r\n│  UI Layer                                                   │\r\n│  ┌─────────────────┐  ┌─────────────────┐                   │\r\n│  │  TrackList      │  │  TrackUpload    │                   │\r\n│  │  (一覧表示)     │  │  (アップロード) │                   │\r\n│  └────────┬────────┘  └────────┬────────┘                   │\r\n│           │                    │                            │\r\n│           ▼                    ▼                            │\r\n│  ┌─────────────────────────────────────┐                    │\r\n│  │  trackStore (Zustand)               │                    │\r\n│  │  - tracks: Track[]                  │                    │\r\n│  │  - isLoading: boolean               │                    │\r\n│  │  - fetchTracks()                    │                    │\r\n│  └────────────────┬────────────────────┘                    │\r\n│                   │                                         │\r\n│                   ▼                                         │\r\n│  ┌─────────────────────────────────────┐                    │\r\n│  │  trackClient (API Client)           │                    │\r\n│  │  - getAll(), create(), delete()     │                    │\r\n│  └────────────────┬────────────────────┘                    │\r\n└───────────────────┼─────────────────────────────────────────┘\r\n                    │ HTTP\r\n┌───────────────────┼─────────────────────────────────────────┐\r\n│  Server Layer     │                                         │\r\n│                   ▼                                         │\r\n│  ┌─────────────────────────────────────┐                    │\r\n│  │  API Routes (/api/tracks)           │                    │\r\n│  │  - GET: 一覧取得                    │                    │\r\n│  │  - POST: 新規作成                   │                    │\r\n│  │  - DELETE: 削除                     │                    │\r\n│  └────────────────┬────────────────────┘                    │\r\n│                   │                                         │\r\n│                   ▼                                         │\r\n│  ┌─────────────────────────────────────┐                    │\r\n│  │  TrackService                       │                    │\r\n│  │  implements ITrackService           │                    │\r\n│  │  - getAllTracks()                   │                    │\r\n│  │  - createTrack()                    │                    │\r\n│  │  - deleteTrack()                    │                    │\r\n│  └────────────────┬────────────────────┘                    │\r\n│                   │                                         │\r\n│                   ▼                                         │\r\n│  ┌─────────────────────────────────────┐                    │\r\n│  │  TrackRepository                    │                    │\r\n│  │  implements ITrackRepository        │                    │\r\n│  │  - findAll(), create(), delete()    │                    │\r\n│  └────────────────┬────────────────────┘                    │\r\n│                   │                                         │\r\n│                   ▼                                         │\r\n│  ┌─────────────────────────────────────┐                    │\r\n│  │  Supabase (DB + Storage)            │                    │\r\n│  └─────────────────────────────────────┘                    │\r\n└─────────────────────────────────────────────────────────────┘\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### Server Side\r\n\r\n#### ITrackRepository\r\n\r\n```typescript\r\n// types/interfaces/track-repository.ts\r\nexport interface ITrackRepository {\r\n  findAll(options?: { search?: string; sortBy?: string; order?: 'asc' | 'desc' }): Promise<Track[]>;\r\n  findById(id: string): Promise<Track | null>;\r\n  create(input: CreateTrackInput): Promise<Track>;\r\n  delete(id: string): Promise<void>;\r\n}\r\n```\r\n\r\n#### ITrackService\r\n\r\n```typescript\r\n// types/interfaces/track-service.ts\r\nexport interface ITrackService {\r\n  getAllTracks(options?: TrackQueryOptions): Promise<Track[]>;\r\n  getTrackById(id: string): Promise<Track | null>;\r\n  createTrack(file: File, metadata?: Partial<CreateTrackInput>): Promise<Track>;\r\n  deleteTrack(id: string): Promise<void>;\r\n}\r\n```\r\n\r\n#### TrackRepository\r\n\r\n- **Purpose:** Supabase との直接的なデータ操作\r\n- **Interfaces:** `ITrackRepository`\r\n- **Dependencies:** Supabase Client\r\n- **Location:** `server/repositories/track-repository.ts`\r\n\r\n#### TrackService\r\n\r\n- **Purpose:** ビジネスロジック（ファイルアップロード、ID3タグ抽出、バリデーション）\r\n- **Interfaces:** `ITrackService`\r\n- **Dependencies:** `ITrackRepository`, Supabase Storage\r\n- **Location:** `server/services/track-service.ts`\r\n\r\n### Client Side\r\n\r\n#### trackStore (Zustand)\r\n\r\n```typescript\r\n// stores/track-store.ts\r\ninterface TrackState {\r\n  tracks: Track[];\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  searchQuery: string;\r\n  sortBy: 'createdAt' | 'title' | 'artist';\r\n  sortOrder: 'asc' | 'desc';\r\n  \r\n  // Actions\r\n  fetchTracks: () => Promise<void>;\r\n  uploadTrack: (file: File) => Promise<void>;\r\n  deleteTrack: (id: string) => Promise<void>;\r\n  setSearchQuery: (query: string) => void;\r\n  setSortBy: (sortBy: string) => void;\r\n}\r\n```\r\n\r\n#### trackClient\r\n\r\n- **Purpose:** API との通信\r\n- **Location:** `services/track-client.ts`\r\n- **Methods:** `getAll()`, `create()`, `delete()`, `getById()`\r\n\r\n### UI Components\r\n\r\n#### TrackList (Container)\r\n\r\n- **Purpose:** 楽曲一覧の表示、検索、ソート\r\n- **Location:** `components/features/track-list.tsx`\r\n- **Dependencies:** `trackStore`, `TrackItem`\r\n\r\n#### TrackItem (Presentational)\r\n\r\n- **Purpose:** 単一楽曲の表示\r\n- **Location:** `components/ui/track-item.tsx`\r\n- **Props:** `track: Track`, `onDelete: () => void`, `onClick: () => void`\r\n\r\n#### TrackUpload (Container)\r\n\r\n- **Purpose:** ファイルアップロード UI\r\n- **Location:** `components/features/track-upload.tsx`\r\n- **Features:** ドラッグ&ドロップ、複数ファイル対応、進捗表示\r\n\r\n#### TrackDetail (Container)\r\n\r\n- **Purpose:** 楽曲詳細表示モーダル\r\n- **Location:** `components/features/track-detail.tsx`\r\n\r\n## Data Models\r\n\r\n### Track\r\n\r\n```typescript\r\n// types/models/track.ts\r\nexport type Track = {\r\n  id: string;\r\n  title: string;\r\n  artist: string;\r\n  album: string | null;\r\n  duration: number;          // 秒数\r\n  filePath: string;          // Supabase Storage パス\r\n  fileUrl: string;           // 署名付き URL（取得時に生成）\r\n  coverUrl: string | null;   // カバー画像 URL\r\n  fileSize: number;          // バイト数\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n};\r\n\r\nexport type CreateTrackInput = {\r\n  title: string;\r\n  artist: string;\r\n  album: string | null;\r\n  duration: number;\r\n  filePath: string;\r\n  fileSize: number;\r\n  coverUrl: string | null;\r\n};\r\n\r\nexport type TrackQueryOptions = {\r\n  search?: string;\r\n  sortBy?: 'createdAt' | 'title' | 'artist';\r\n  order?: 'asc' | 'desc';\r\n};\r\n```\r\n\r\n### Database Schema (Supabase)\r\n\r\n```sql\r\nCREATE TABLE tracks (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  title TEXT NOT NULL,\r\n  artist TEXT NOT NULL DEFAULT 'Unknown Artist',\r\n  album TEXT,\r\n  duration INTEGER NOT NULL,\r\n  file_path TEXT NOT NULL,\r\n  file_size INTEGER NOT NULL,\r\n  cover_url TEXT,\r\n  created_at TIMESTAMPTZ DEFAULT NOW(),\r\n  updated_at TIMESTAMPTZ DEFAULT NOW()\r\n);\r\n\r\n-- インデックス\r\nCREATE INDEX idx_tracks_title ON tracks(title);\r\nCREATE INDEX idx_tracks_artist ON tracks(artist);\r\nCREATE INDEX idx_tracks_created_at ON tracks(created_at DESC);\r\n```\r\n\r\n### Supabase Storage\r\n\r\n```\r\nBucket: tracks\r\n├── {uuid}.mp3           # 音楽ファイル\r\n└── covers/\r\n    └── {uuid}.jpg       # カバー画像（将来対応）\r\n```\r\n\r\n## API Design\r\n\r\n### GET /api/tracks\r\n\r\n楽曲一覧を取得\r\n\r\n**Query Parameters:**\r\n- `search`: 検索クエリ（タイトル、アーティスト、アルバム）\r\n- `sortBy`: ソートキー（createdAt, title, artist）\r\n- `order`: ソート順（asc, desc）\r\n\r\n**Response:**\r\n```json\r\n{\r\n  \"tracks\": [\r\n    {\r\n      \"id\": \"uuid\",\r\n      \"title\": \"Song Title\",\r\n      \"artist\": \"Artist Name\",\r\n      \"album\": \"Album Name\",\r\n      \"duration\": 240,\r\n      \"fileUrl\": \"https://...\",\r\n      \"coverUrl\": \"https://...\",\r\n      \"fileSize\": 5242880,\r\n      \"createdAt\": \"2025-12-03T00:00:00Z\",\r\n      \"updatedAt\": \"2025-12-03T00:00:00Z\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n### GET /api/tracks/[id]\r\n\r\n楽曲詳細を取得\r\n\r\n**Response:**\r\n```json\r\n{\r\n  \"track\": { ... }\r\n}\r\n```\r\n\r\n### POST /api/tracks\r\n\r\n楽曲をアップロード\r\n\r\n**Request:** `multipart/form-data`\r\n- `file`: MP3 ファイル（必須）\r\n- `title`: タイトル（任意、ID3タグから自動取得）\r\n- `artist`: アーティスト（任意）\r\n- `album`: アルバム（任意）\r\n\r\n**Response:**\r\n```json\r\n{\r\n  \"track\": { ... }\r\n}\r\n```\r\n\r\n### DELETE /api/tracks/[id]\r\n\r\n楽曲を削除\r\n\r\n**Response:**\r\n```json\r\n{\r\n  \"success\": true\r\n}\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n1. **ファイルサイズ超過（50MB以上）**\r\n   - **Handling:** アップロード前にクライアント側で検証\r\n   - **User Impact:** 「ファイルサイズが大きすぎます（最大50MB）」\r\n\r\n2. **非対応ファイル形式**\r\n   - **Handling:** MIME タイプを検証（audio/mpeg のみ許可）\r\n   - **User Impact:** 「MP3ファイルのみアップロード可能です」\r\n\r\n3. **アップロード失敗**\r\n   - **Handling:** リトライボタン表示、エラーログ記録\r\n   - **User Impact:** 「アップロードに失敗しました。再試行してください」\r\n\r\n4. **楽曲が見つからない**\r\n   - **Handling:** 404 レスポンス\r\n   - **User Impact:** 「楽曲が見つかりません」\r\n\r\n5. **データベースエラー**\r\n   - **Handling:** 500 レスポンス、エラーログ記録\r\n   - **User Impact:** 「エラーが発生しました。しばらくしてから再試行してください」\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n- **TrackRepository**: Supabase モックを使用した CRUD テスト\r\n- **TrackService**: Repository モックを使用したビジネスロジックテスト\r\n- **trackStore**: API モックを使用した状態管理テスト\r\n\r\n### Integration Testing\r\n\r\n- **API Routes**: MSW を使用したエンドポイントテスト\r\n- **Upload Flow**: ファイルアップロード→DB保存→Storage保存の統合テスト\r\n\r\n### End-to-End Testing\r\n\r\n- ファイルアップロード→一覧表示→削除のフロー\r\n- 検索・ソート機能のテスト\r\n\r\n## File Structure\r\n\r\n```\r\nweb/src/\r\n├── app/\r\n│   └── tracks/\r\n│       └── page.tsx              # 楽曲一覧ページ\r\n├── server/\r\n│   ├── api/\r\n│   │   └── tracks/\r\n│   │       ├── route.ts          # GET, POST\r\n│   │       └── [id]/\r\n│   │           └── route.ts      # GET, DELETE\r\n│   ├── services/\r\n│   │   └── track-service.ts\r\n│   ├── repositories/\r\n│   │   └── track-repository.ts\r\n│   └── lib/\r\n│       └── supabase.ts\r\n├── components/\r\n│   ├── features/\r\n│   │   ├── track-list.tsx\r\n│   │   ├── track-upload.tsx\r\n│   │   └── track-detail.tsx\r\n│   └── ui/\r\n│       ├── track-item.tsx\r\n│       └── file-dropzone.tsx\r\n├── stores/\r\n│   └── track-store.ts\r\n├── services/\r\n│   └── track-client.ts\r\n├── types/\r\n│   ├── models/\r\n│   │   └── track.ts\r\n│   ├── interfaces/\r\n│   │   ├── track-repository.ts\r\n│   │   └── track-service.ts\r\n│   └── api/\r\n│       └── track-api.ts\r\n└── lib/\r\n    └── api/\r\n        └── client.ts\r\n```\r\n",
  "fileStats": {
    "size": 15517,
    "lines": 437,
    "lastModified": "2025-12-03T11:14:58.462Z"
  },
  "comments": []
}